# TG Flowers Bot

Telegram-бот — цветочный магазин с микросервисной архитектурой.

## Архитектура

Проект состоит из следующих микросервисов:

| Сервис | Порт | Описание |
|--------|------|----------|
| **catalog-service** | 8001 | Управление каталогом товаров, категориями, магазинами |
| **order-service** | 8002 | Корзина и оформление заказов |
| **analytics-service** | 8003 | Аналитика и метрики (просмотры, популярные товары) |
| **main-bot** | — | Telegram-бот для покупателей |
| **admin-bot** | — | Telegram-бот для администраторов |
| **nginx** | 80 | Прокси для API + раздача веб-приложений |
| **PostgreSQL** | 5432 | База данных |
| **Kafka + Zookeeper** | 9092 | Очередь сообщений между сервисами |

### Технологии

- **Python 3.11** — FastAPI, python-telegram-bot, SQLAlchemy (async), aiokafka
- **PostgreSQL 15** — хранение данных
- **Apache Kafka** — межсервисное взаимодействие (события просмотров, заказов)
- **Docker / Docker Compose** — контейнеризация и оркестрация
- **Nginx** — API-шлюз и раздача статики

## Функциональность

### Бот для покупателей (main-bot)
- Отправка местоположения или выбор адреса на карте
- Просмотр каталога через Telegram Web App (категории, товары, цены)
- Просмотр деталей товара (изображение, цена, описание, наличие в магазинах)
- Корзина товаров (добавление, изменение количества, удаление)
- Оформление заказа: самовывоз (выбор магазина и времени) или доставка (подтверждение адреса)
- Просмотр истории заказов

### Бот для администраторов (admin-bot)
- Управление каталогом (добавление, редактирование, удаление товаров и категорий)
- Управление наличием товаров по магазинам
- Просмотр и управление заказами (изменение статуса)
- Дашборд метрик:
  - Количество заказов, выручка, средний чек
  - Популярные товары по просмотрам и по заказам

## Запуск

### 1. Настройка

Скопируйте файл `.env.example` в `.env` и укажите токены ботов:

```bash
cp .env.example .env
```

Отредактируйте `.env`:
```
MAIN_BOT_TOKEN=ваш_токен_основного_бота
ADMIN_BOT_TOKEN=ваш_токен_бота_админки
```

### 2. Запуск всех сервисов

```bash
docker compose up --build
```

### 3. Остановка

```bash
docker compose down
```

## API

Все API доступны через nginx на порту 80:

- `GET /api/catalog/categories/` — список категорий
- `GET /api/catalog/products/` — список товаров
- `GET /api/catalog/products/{id}/` — детали товара
- `GET /api/catalog/products/{id}/availability/` — наличие товара
- `GET /api/catalog/stores/` — список магазинов
- `GET /api/catalog/stores/nearby?lat=...&lon=...` — ближайшие магазины
- `GET /api/orders/cart/{user_id}/` — корзина пользователя
- `POST /api/orders/cart/{user_id}/items/` — добавить в корзину
- `POST /api/orders/orders/` — создать заказ
- `GET /api/orders/orders/` — список заказов
- `GET /api/analytics/analytics/dashboard` — дашборд метрик

## Структура проекта

```
├── docker-compose.yml
├── nginx/
│   └── nginx.conf
├── services/
│   ├── catalog-service/    # FastAPI: каталог товаров
│   ├── order-service/      # FastAPI: корзина и заказы
│   ├── analytics-service/  # FastAPI: аналитика
│   ├── main-bot/           # Telegram-бот покупателя
│   └── admin-bot/          # Telegram-бот администратора
└── webapp/
    ├── customer/           # Web App для покупателей
    └── admin/              # Web App для администраторов
```
